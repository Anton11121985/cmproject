<collection name="Missions_(project_by_stage)" idField="id" replace="runtime">
    <prototype>
        <![CDATA[
        SELECT
    id,
    self_1,
    self_2,
    self_3,
    Module,
    created_date,
    hasGriff,
    hasAttachments,
    regDate,
    reqType,
    stageStatus,
    signerName,
    executorName,
    linkedDoc,
    subject,
    regPlace,
    projectNumber
FROM (         SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                                 WHEN (rkk.regisinprocess = 1) THEN 'На регистрации'
                                 WHEN (rkk.regisrejected = 1) THEN 'Отказано в регистрации'
                                 WHEN (rkk.isonrework = 1) THEN 'На доработке'
                                 END AS stageStatus,
CASE
                                 WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)  ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and (rkk.regisinprocess = 1 OR rkk.regisrejected = 1 OR rkk.isonrework = 1)


		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                                 WHEN (ordrkk.signissigned = 1) THEN 'Подписан'
                                 WHEN (ordrkk.signissentto = 1) THEN 'На подписании'
                                 WHEN (ordrkk.signisrejected = 1) THEN 'В подписании отказано'
                                 WHEN (ordrkk.signissentto = 0 and ordrkk.signsenttodt is not null)
                                     THEN 'Отозван с подписания'
                                 END AS stageStatus,
CASE
                               WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)   ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and (ordrkk.signissigned = 1 or ordrkk.signissentto = 1 or ordrkk.signisrejected = 1 or (ordrkk.signissentto = 0 and ordrkk.signsenttodt is not null))



		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                                WHEN (ordrkk.appraddstatus = 'APPROVED_COMMENTS' or ordrkk.appraddstatus = 'APPROVED_POSITIVE' and exists (select 1
                                       from apr_voresult vo
                                       where vo.HierRoot = ordrkk.id and IsVisa = 1 and not InterruptedBy is null
                                       LIMIT 1
                                      ))
                                     THEN 'Снятие замечаний завершено или прекращено'
                                 WHEN ordrkk.isAfterApproving = 1 THEN 'Обработка согласования'
                                 WHEN (ordrkk.apprisunder = 1 and (ordrkk.appraddstatus = 'APPROVED_POSITIVE'
                                     or ordrkk.appraddstatus = 'APPROVED_COMMENTS')) THEN 'Снятие замечаний'
                                 WHEN (ordrkk.apprisunder = 1) THEN 'На согласовании'
                                 END AS stageStatus,
CASE
              WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)    ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null AND (ordrkk.appraddstatus is not NULL and ( ordrkk.appraddstatus = 'APPROVED_COMMENTS' or ordrkk.appraddstatus = 'APPROVED_POSITIVE') and exists (select 1
                                       from apr_voresult vo
                                       where vo.HierRoot = ordrkk.id and IsVisa = 1 and not InterruptedBy is null
                                       LIMIT 1
                                      ) or ordrkk.isAfterApproving = 1 OR ordrkk.apprisunder = 1)

		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                               WHEN (rkk.ctrldateexecution IS NOT NULL) THEN 'Исполнен'
                                 WHEN (ordrkk.resolutionsstate = 'work') THEN 'На исполнении'
                                 END AS stageStatus,
CASE
                 WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)
                 ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and (rkk.ctrldateexecution IS NOT NULL OR ordrkk.resolutionsstate = 'work')


		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              'Инициирование' AS stageStatus,
CASE
                 WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)
                 ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
          WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and not (rkk.ctrldateexecution IS NOT NULL OR (ordrkk.resolutionsstate is NOT null and ordrkk.resolutionsstate = 'work') or ((ordrkk.appraddstatus = 'APPROVED_COMMENTS' or ordrkk.appraddstatus = 'APPROVED_POSITIVE') and exists (select 1
                                       from apr_voresult vo
                                       where vo.HierRoot = ordrkk.id and IsVisa = 1 and not InterruptedBy is null
                                       LIMIT 1
                                      ))  or ordrkk.isAfterApproving = 1 OR ordrkk.apprisunder = 1 OR rkk.regisinprocess = 1 OR rkk.regisrejected = 1 OR rkk.isonrework = 1 or ordrkk.signissigned = 1 or ordrkk.signissentto = 1 or ordrkk.signisrejected = 1 or (ordrkk.signissentto = 0 and ordrkk.signsenttodt is not null))
     ) as s
       WHERE 1=1
        ::where-clause
]]>
    </prototype>
    <counting-prototype>
        <![CDATA[
            SELECT
                    COUNT(1)
                FROM (        SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                                 WHEN (rkk.regisinprocess = 1) THEN 'На регистрации'
                                 WHEN (rkk.regisrejected = 1) THEN 'Отказано в регистрации'
                                 WHEN (rkk.isonrework = 1) THEN 'На доработке'
                                 END AS stageStatus,
CASE
                                 WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)  ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and (rkk.regisinprocess = 1 OR rkk.regisrejected = 1 OR rkk.isonrework = 1)


		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                                 WHEN (ordrkk.signissigned = 1) THEN 'Подписан'
                                 WHEN (ordrkk.signissentto = 1) THEN 'На подписании'
                                 WHEN (ordrkk.signisrejected = 1) THEN 'В подписании отказано'
                                 WHEN (ordrkk.signissentto = 0 and ordrkk.signsenttodt is not null)
                                     THEN 'Отозван с подписания'
                                 END AS stageStatus,
CASE
                               WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)   ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and (ordrkk.signissigned = 1 or ordrkk.signissentto = 1 or ordrkk.signisrejected = 1 or (ordrkk.signissentto = 0 and ordrkk.signsenttodt is not null))



		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                                WHEN (ordrkk.appraddstatus = 'APPROVED_COMMENTS' or ordrkk.appraddstatus = 'APPROVED_POSITIVE' and exists (select 1
                                       from apr_voresult vo
                                       where vo.HierRoot = ordrkk.id and IsVisa = 1 and not InterruptedBy is null
                                       LIMIT 1
                                      ))
                                     THEN 'Снятие замечаний завершено или прекращено'
                                 WHEN ordrkk.isAfterApproving = 1 THEN 'Обработка согласования'
                                 WHEN (ordrkk.apprisunder = 1 and (ordrkk.appraddstatus = 'APPROVED_POSITIVE'
                                     or ordrkk.appraddstatus = 'APPROVED_COMMENTS')) THEN 'Снятие замечаний'
                                 WHEN (ordrkk.apprisunder = 1) THEN 'На согласовании'
                                 END AS stageStatus,
CASE
              WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)    ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null AND (ordrkk.appraddstatus is not NULL and ( ordrkk.appraddstatus = 'APPROVED_COMMENTS' or ordrkk.appraddstatus = 'APPROVED_POSITIVE') and exists (select 1
                                       from apr_voresult vo
                                       where vo.HierRoot = ordrkk.id and IsVisa = 1 and not InterruptedBy is null
                                       LIMIT 1
                                      ) or ordrkk.isAfterApproving = 1 OR ordrkk.apprisunder = 1)

		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              CASE
                               WHEN (rkk.ctrldateexecution IS NOT NULL) THEN 'Исполнен'
                                 WHEN (ordrkk.resolutionsstate = 'work') THEN 'На исполнении'
                                 END AS stageStatus,
CASE
                 WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)
                 ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
         WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and (rkk.ctrldateexecution IS NOT NULL OR ordrkk.resolutionsstate = 'work')


		 UNION ALL

		          SELECT
             rkkbase.id                                             AS id,
             rkkbase.created_date                                   AS created_date,
             rkkbase.type                                           AS reqType,
             rkkbase.module                                         AS Module,
             '<id>'                                                 AS self_1,
             ':'                                                    AS self_2,
             '</>'                                                  AS self_3,
             rkk.regdate                                            AS regDate,
case when rkkbase.security_stamp is not null then
                             '<iconHint>Есть гриф</><iconId>165</>'
             else ''
             end AS hasGriff,
(SELECT
                  coalesce(max(a), cast(0 AS SMALLINT))
              FROM (
                       SELECT
                           cast(1 AS SMALLINT) a
                       FROM f_ContentFiles_Rkk CF
                       WHERE CF.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_ContentRichText_Rkk CRT
                       WHERE CRT.f_dp_rkkbase = rkk.id
                       UNION ALL SELECT
                           cast(1 AS SMALLINT)
                       FROM f_VerifyImage_Rkk VI
                       WHERE VI.f_dp_rkk = rkk.id
                   ) t
             )                                                AS hasAttachments,
              'Инициирование' AS stageStatus,
CASE
                 WHEN (rkkbase.signingmode = 0) THEN (SELECT signerName.orig_shortname from So_BEARD  signerName where signerName.id = ordrkk.SignSigner)
                 ELSE
                     (SELECT array_to_string(array_agg(orig_shortname), ' ', '')
                     FROM F_DP_Rkk_SigningInfo
                         JOIN so_beard on F_DP_Rkk_SigningInfo.signer = So_beard.id
                     WHERE ordrkk.id = F_DP_Rkk_SigningInfo.owner)
                 END AS signerName,
 COALESCE((SELECT string_agg(beardExec.Orig_ShortName, ',') AS Orig_ShortName
              FROM F_DP_ordRkk_Executor ordexec
              LEFT JOIN so_beard beardExec ON beardExec.id = ordexec.Executor
              WHERE ordexec.owner = rkkbase.id), '<Не указано>')       AS executorName,
rkkbase.subject                                                    AS subject,
(SELECT COALESCE(string_agg((CASE
                                            WHEN link.doclinktype = '' THEN '<id></>'
                                            ELSE (COALESCE(
                                                                    '<id>' || link.docreplid || ':' || link.docunid || '</>',
                                                                    '<id>' || to_char(
                                                                                cast((rkkbase.module_type * 10 ^ 12) as bigint) + rkkbase.module,
                                                                                'FM0000000000000000') ||
                                                                    ':00000000000000000000000000000000' || '</>')) END), ';'),
                            '<id></>')
            FROM F_DP_RkkWORegAndCtrl_ULnk link
            WHERE link.owner = rkk.id)                                         AS linkedDoc,
coalesce(
                     (SELECT
                          CASE WHEN regplace.orig_shortname IS NULL THEN 'Не указано'
                               ELSE regplace.orig_shortname
                              END
                      FROM so_beard RegPlace
                      WHERE RegPlace.id = rkkbase.RegCode),
                     CASE WHEN rkkbase.RegCode IS NULL THEN 'Не указано' END
                 )  AS regPlace,
concat(rkk.prjnumprist, rkk.prjnumcounter, rkk.prjnumfin) as projectNumber
FROM
             f_dp_ordrkk ordrkk
                 JOIN f_dp_rkk rkk ON rkk.id = ordrkk.id
                 JOIN f_dp_rkkbase rkkbase ON rkkbase.id = ordrkk.id
                 JOIN f_dp_rkkworegandctrl rkkworeg ON rkkworeg.id = ordrkk.id
          WHERE rkkbase.isdeleted = 0 and rkk.regnumcnt is null and not (rkk.ctrldateexecution IS NOT NULL OR (ordrkk.resolutionsstate is NOT null and ordrkk.resolutionsstate = 'work') or ((ordrkk.appraddstatus = 'APPROVED_COMMENTS' or ordrkk.appraddstatus = 'APPROVED_POSITIVE') and exists (select 1
                                       from apr_voresult vo
                                       where vo.HierRoot = ordrkk.id and IsVisa = 1 and not InterruptedBy is null
                                       LIMIT 1
                                      ))  or ordrkk.isAfterApproving = 1 OR ordrkk.apprisunder = 1 OR rkk.regisinprocess = 1 OR rkk.regisrejected = 1 OR rkk.isonrework = 1 or ordrkk.signissigned = 1 or ordrkk.signissentto = 1 or ordrkk.signisrejected = 1 or (ordrkk.signissentto = 0 and ordrkk.signsenttodt is not null))
       ) as s
       WHERE 1=1
        ::where-clause
]]>
    </counting-prototype>
    <filter name="self">
        <criteria placeholder="where-clause">
            <![CDATA[
                        Module = {0} and id = {1}
                    ]]>
        </criteria>
    </filter>
    <filter name="MODULE">
        <criteria placeholder="where-clause">
            <![CDATA[
				Module = {0}
			]]>
        </criteria>
    </filter>
    <filter name="hasAttachments">
        <criteria placeholder="where-clause">
            <![CDATA[
                    hasAttachments = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="stageStatus">
        <criteria placeholder="where-clause">
            <![CDATA[
                    stageStatus = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="stageStatus_partial">
        <criteria placeholder="where-clause">
            <![CDATA[
                    stageStatus iLIKE '%'||{0}||'%'
                ]]>
        </criteria>
    </filter>
    <filter name="regDate">
        <criteria placeholder="where-clause">
            <![CDATA[
                    cast(regDate as date) = cast({0} as date)
                ]]>
        </criteria>
    </filter>
    <filter name="regDate_partial">
        <criteria placeholder="where-clause">
            <![CDATA[
                     ('б/д' ilike '%'||{0}||'%' and (regDate is null))
                ]]>
        </criteria>
    </filter>
    <filter name="regDate_interval">
        <criteria placeholder="where-clause">
            <![CDATA[
              cast(regDate as date) >= cast({0} as date) and cast(regDate as date) <= cast({1} as date)
                ]]>
        </criteria>
    </filter>
    <filter name="reqType">
        <criteria placeholder="where-clause">
            <![CDATA[
                	reqType = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="reqType_partial">
        <criteria placeholder="where-clause">
            <![CDATA[
                        reqType ilike '%'||{0}||'%'
                    ]]>
        </criteria>
    </filter>
    <filter name="signerName">
        <criteria placeholder="where-clause">
            <![CDATA[
                    signerName = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="signerName_partial">
        <criteria placeholder="where-clause">
            <![CDATA[
                signerName iLIKE ('%'||{0}||'%')
            ]]>
        </criteria>
    </filter>
    <filter name="linkedDoc">
        <criteria placeholder="where-clause">
            <![CDATA[
                    linkedDoc = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="subject">
        <criteria placeholder="where-clause">
            <![CDATA[
                    subject = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="subject_partial">
        <criteria placeholder="where-clause">
            <![CDATA[
                    subject iLIKE '%'||{0}||'%'
                ]]>
        </criteria>
    </filter>
    <filter name="regPlace">
        <criteria placeholder="where-clause">
            <![CDATA[
                    regPlace = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="regPlace_partial">
        <criteria placeholder="where-clause">
            <![CDATA[
                    regplace iLIKE '%'||{0}||'%'
                ]]>
        </criteria>
    </filter>
    <filter name="projectNumber">
        <criteria placeholder="where-clause">
            <![CDATA[
                projectNumber = {0}
            ]]>
        </criteria>
    </filter>
    <filter name="executorName">
        <criteria placeholder="where-clause">
            <![CDATA[
                    executorName = {0}
                ]]>
        </criteria>
    </filter>
    <filter name="executorName_partial">
        <criteria placeholder="where-clause">
            <![CDATA[
                executorName iLIKE ('%'||{0}||'%')
            ]]>
        </criteria>
    </filter>
</collection>